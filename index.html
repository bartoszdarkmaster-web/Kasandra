<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KASSANDRA v5.1 – Strategic Early Warning System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body{margin:0;background:#0b0f17;color:#e5e7eb;font-family:system-ui}
header{padding:16px;border-bottom:1px solid #1f2937}
h1{margin:0;font-size:20px}
main{padding:16px;max-width:1100px;margin:auto}
.card{background:#121826;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:16px}
.risk{font-size:42px;font-weight:800;color:#ef4444}
.scale{height:10px;border-radius:6px;background:linear-gradient(90deg,#22c55e,#f59e0b,#ef4444);margin:10px 0;position:relative}
.marker{position:absolute;top:-4px;width:4px;height:18px;background:#fff}
button{background:#1f2937;color:#e5e7eb;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button:hover{background:#374151}
.meta{display:flex;gap:12px;flex-wrap:wrap;font-size:14px}
.impact-item{border-bottom:1px solid #1f2937;padding:8px 0;cursor:pointer}
.impact-details{display:none;font-size:13px;color:#9ca3af;margin-left:60px}
#map{height:450px;border-radius:12px}
#legend,#layers{position:absolute;right:10px;background:#0c1225;padding:8px;border-radius:8px;font-size:12px;z-index:1000}
#legend{bottom:10px}
#layers{top:10px}
</style>
</head>

<body>

<header>
<h1>KASSANDRA – Strategic Early Warning System</h1>
</header>

<main>

<!-- DECISION MODE -->
<div class="card">
  <div class="risk" id="riskLevel">HIGH</div>
  <div class="scale"><div class="marker" id="riskMarker"></div></div>
  <div class="meta">
    <div>CEPI: <b id="cepi">0.00</b></div>
    <div>Confidence: <b id="conf">0%</b></div>
  </div>
  <br>
  <button onclick="updateNow()">UPDATE NOW</button>
</div>

<!-- DLACZEGO -->
<div class="card">
<h3>CO WPŁYNĘŁO NA OCENĘ</h3>
<div id="impactList"></div>
</div>

<!-- MAPA -->
<div class="card" style="position:relative">
<div id="map"></div>

<div id="layers">
<label><input type="checkbox" checked onchange="toggleLayer('military',this)"> Wojsko</label><br>
<label><input type="checkbox" checked onchange="toggleLayer('logistics',this)"> Logistyka</label><br>
<label><input type="checkbox" checked onchange="toggleLayer('medical',this)"> Medyczne</label>
</div>

<div id="legend">
<b>Legenda</b><br>
<span style="color:#ef4444">●</span> Wojsko<br>
<span style="color:#f59e0b">●</span> Logistyka<br>
<span style="color:#22c55e">●</span> Medyczne
</div>
</div>

</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== DANE TESTOWE (Z PUNKTAMI) ===== */
let events = [
{title:"Koncentracja wojsk",category:"military",delta:0.04,confidence:0.88,lat:53.9,lon:27.56,sources:["Satellite imagery"]},
{title:"Transporty paliwa",category:"logistics",delta:0.03,confidence:0.82,lat:47.9,lon:37.8,sources:["Rail OSINT"]},
{title:"Szpital polowy",category:"medical",delta:0.02,confidence:0.80,lat:51.5,lon:31.3,sources:["Medical OSINT"]}
];

const weights={military:0.2,logistics:0.25,medical:0.2};

/* ===== MAPA ===== */
const map = L.map("map").setView([20,0],2);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:6,
  attribution:"© OpenStreetMap"
}).addTo(map);

/* WARSTWY – JAWNIE DODANE */
const layers = {
  military: L.layerGroup().addTo(map),
  logistics: L.layerGroup().addTo(map),
  medical: L.layerGroup().addTo(map)
};

function color(cat){
  return cat==="military"?"#ef4444":
         cat==="logistics"?"#f59e0b":
         "#22c55e";
}

/* ===== CEPI ===== */
function calcCEPI(){
  let sum=0,conf=0;
  events.forEach(e=>{
    sum+=e.delta*(weights[e.category]||0.1)*e.confidence;
    conf+=e.confidence;
  });
  document.getElementById("cepi").innerText=sum.toFixed(2);
  document.getElementById("conf").innerText=((conf/events.length)*100).toFixed(0)+"%";
  document.getElementById("riskMarker").style.left=(sum*100)+"%";
  document.getElementById("riskLevel").innerText =
    sum>0.85?"CRITICAL":sum>0.7?"HIGH":sum>0.5?"ELEVATED":"LOW";
}

/* ===== DLACZEGO ===== */
function renderImpact(){
  const c=document.getElementById("impactList");
  c.innerHTML="";
  events.forEach(e=>{
    const d=document.createElement("div");
    d.className="impact-item";
    d.innerHTML=`▲ ${e.delta} ${e.title}`;
    const det=document.createElement("div");
    det.className="impact-details";
    det.innerHTML=`Pewność: ${e.confidence*100}%<br>Źródła: ${e.sources.join(", ")}`;
    d.onclick=()=>det.style.display=det.style.display==="block"?"none":"block";
    d.appendChild(det);
    c.appendChild(d);
  });
}

/* ===== MAPA – RYSOWANIE PUNKTÓW ===== */
function renderMap(){
  Object.values(layers).forEach(l=>l.clearLayers());

  events.forEach(e=>{
    if(!e.lat || !e.lon) return;

    const m = L.circleMarker([e.lat,e.lon],{
      radius: 8 + e.delta*120,
      color: color(e.category),
      fillColor: color(e.category),
      fillOpacity: 0.85,
      weight: 1
    }).bindPopup(`
      <b>${e.title}</b><br>
      Wpływ: +${e.delta}<br>
      Pewność: ${(e.confidence*100).toFixed(0)}%
    `);

    layers[e.category].addLayer(m);
  });

  /* MARKER TESTOWY – ZAWSZE WIDOCZNY */
  L.marker([52,21]).addTo(map).bindPopup("TEST MARKER – mapa działa");
}

/* ===== TOGGLE WARSTW ===== */
function toggleLayer(name, checkbox){
  checkbox.checked ? map.addLayer(layers[name]) : map.removeLayer(layers[name]);
}

/* ===== UPDATE ===== */
function updateNow(){
  calcCEPI();
  renderImpact();
  renderMap();
}

/* INIT */
updateNow();

/* FIX LEAFLET */
setTimeout(()=>map.invalidateSize(),300);
</script>

</body>
</html>
